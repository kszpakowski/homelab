apiVersion: argoproj.io/v1alpha1
kind: Application
metadata:
  name: vm-stack
  namespace: argocd
  finalizers:
    - resources-finalizer.argocd.argoproj.io
spec:
  project: default
  sources:
    - repoURL: https://victoriametrics.github.io/helm-charts/
      targetRevision: "0.67.0"
      chart: victoria-metrics-k8s-stack
      helm:
        valuesObject:
          grafana:
            envFromSecret: grafana-pocketid-oidc
            grafana.ini:
              server:
                root_url: https://grafana.homelab.kszpakowski.com
              auth.generic_oauth:
                enabled: true
                name: Pocket ID
                allow_sign_up: true
                client_id: ${OIDC_CLIENT_ID}
                client_secret: ${OIDC_CLIENT_SECRET}
                scopes: openid profile email
                issuer: https://id.homelab.kszpakowski.com
            ingress:
              enabled: true
              hosts:
                - grafana.homelab.kszpakowski.com
              annotations:
                cert-manager.io/cluster-issuer: letsencrypt
              tls:
                - hosts:
                    - grafana.homelab.kszpakowski.com
                  secretName: grafana-cert
    - repoURL: 'https://github.com/kszpakowski/homelab.git'
      path: ./victoria-metrics-k8s-stack
      targetRevision: HEAD
  destination:
    server: https://kubernetes.default.svc
    namespace: vm-stack
  syncPolicy:
    automated:
      prune: true
      selfHeal: true
    syncOptions:
    - CreateNamespace=true
    - ServerSideApply=true
    - RespectIgnoreDifferences=true
    managedNamespaceMetadata:
      labels:
        pod-security.kubernetes.io/audit: privileged
        pod-security.kubernetes.io/enforce: privileged
        pod-security.kubernetes.io/enforce-version: latest
        pod-security.kubernetes.io/warn: privileged
  ignoreDifferences:
    - group: ""
      kind: Secret
      name: vm-stack-victoria-metrics-operator-validation
      namespace: vm-stack
      jsonPointers:
        - /data
    - group: admissionregistration.k8s.io
      kind: ValidatingWebhookConfiguration
      name: vm-stack-victoria-metrics-operator-admission
      jqPathExpressions:
      - '.webhooks[]?.clientConfig.caBundle'